version = 1

[install]
# Core tools
localstack.pkg-path = "localstack"
kubectl.pkg-path = "kubectl"
gum.pkg-path = "gum"
awscli2.pkg-path = "awscli2"

# Python runtime
python3.pkg-path = "python313Full"
python3.priority = 1

# PyTorch stack (generic for now - will switch to AVX2-optimized builds when available)
# Target: flox/pytorch-python313-cpu-avx2 once published
pytorch.pkg-path = "python313Packages.pytorch"
pytorch.systems = ["x86_64-linux", "x86_64-darwin"]
pytorch.priority = 2

torchvision.pkg-path = "python313Packages.torchvision"
torchvision.systems = ["x86_64-linux", "x86_64-darwin"]
torchvision.priority = 3

# Note: torchaudio not in python313Packages yet, will add when AVX2 builds ready

# ML/NLP libraries
transformers.pkg-path = "python313Packages.transformers"
sentence-transformers.pkg-path = "python313Packages.sentence-transformers"
tokenizers.pkg-path = "python313Packages.tokenizers"

# AWS SDK
boto3.pkg-path = "python313Packages.boto3"
botocore.pkg-path = "python313Packages.botocore"

# Utilities
pydantic.pkg-path = "python313Packages.pydantic"
pytest.pkg-path = "python313Packages.pytest"

[services]
localstack.command = "localstack start -d"
localstack.is-daemon = true
localstack.shutdown.command = "localstack stop"

[include]
environments = [
    { remote = "barstoolbluz/reinvent-demo-ticket-generator" },
    { remote = "barstoolbluz/reinvent-demo-ticket-processor" }
]

[vars]
# LocalStack
AWSCLILOCAL_PACKAGE="awscli-local"
USE_LOCALSTACK="true"
AWS_ENDPOINT_URL="http://localhost:4566"
AWS_REGION="us-east-1"
AWS_ACCESS_KEY_ID="test"
AWS_SECRET_ACCESS_KEY="test"

# ML Model caching
MODEL_CACHE_DIR="$FLOX_ENV_CACHE/models"
TRANSFORMERS_CACHE="$FLOX_ENV_CACHE/models/transformers"
HF_HOME="$FLOX_ENV_CACHE/models/huggingface"

# Python
PYTHONUNBUFFERED="1"

[hook]
on-activate = '''
# Make a spinner we can skip this in CI
function with_spinner() {
  if [[ "$FLOX_ENVS_TESTING" == "1" ]]; then
    bash -c "$2"
  else
    gum spin \
      --show-error \
      --spinner line \
      --title "$1" \
        -- bash -c "$2"
  fi
}

# Create cache directories
mkdir -p "$FLOX_ENV_CACHE/models/"{transformers,huggingface}
mkdir -p "$FLOX_ENV_CACHE/localstack"

# Make a venv
export PYTHON_DIR="$FLOX_ENV_CACHE/python"
if [ ! -d "$PYTHON_DIR" ]; then
  with_spinner "Creating venv in $PYTHON_DIR..." "python -m venv \"$PYTHON_DIR\""
  echo "‚úÖ Created venv"
fi

(
  source "$PYTHON_DIR/bin/activate"
  with_spinner "Installing $AWSCLILOCAL_PACKAGE..." "pip install $AWSCLILOCAL_PACKAGE"
  echo "‚úÖ Installed $AWSCLILOCAL_PACKAGE"
)

if [[ "$FLOX_ACTIVATE_START_SERVICES" == "true" ]]; then
  gum style --border double --margin "1 2" --padding "1 4" \
    'Localstack may take a few moments to start.' '' \
    'Once it starts, see available services with:' \
    '  localstack status services'
else
  gum style --border double --margin "1 2" --padding "1 4" \
    'You may need to start localstack using:' \
    '  flox services start'
fi
'''

[profile]
bash = '''
source "$PYTHON_DIR/bin/activate"

# Wait for LocalStack and setup resources (only if services were started)
if [[ "$FLOX_ACTIVATE_START_SERVICES" == "true" ]]; then
  # Quick check: do resources already exist? (idempotent - skip if already setup)
  if awslocal sqs get-queue-url --queue-name ticket-processing-queue >/dev/null 2>&1; then
    echo "‚úÖ LocalStack resources already configured"
  else
    # Resources missing - wait for LocalStack to be ready
    echo "‚è≥ Waiting for LocalStack to be ready..."

    for i in {1..60}; do
      if curl -sf http://localhost:4566/_localstack/health >/dev/null 2>&1; then
        echo "‚úÖ LocalStack is responding"
        sleep 2  # Grace period for services to fully initialize

        # Initialize resources
        echo "üîß Setting up LocalStack resources..."
        if [ -f "Makefile" ]; then
          make setup 2>&1 | grep -E "(‚úì|‚úó|Error)" || true
          make seed 2>&1 | grep -E "(‚úì|‚úó|Uploaded)" || true
          echo "‚úÖ Resources configured"
        elif [ -f "$FLOX_ENV/share/setup/Makefile" ]; then
          cd "$FLOX_ENV/share/setup"
          make setup 2>&1 | grep -E "(‚úì|‚úó|Error)" || true
          make seed 2>&1 | grep -E "(‚úì|‚úó|Uploaded)" || true
          cd "$FLOX_ENV_PROJECT"
          echo "‚úÖ Resources configured"
        else
          echo "‚ö†Ô∏è  No Makefile found - skipping setup"
        fi
        break
      fi

      if [ $i -eq 60 ]; then
        echo "‚ö†Ô∏è  LocalStack health check timed out after 60 seconds"
      fi
      sleep 1
    done
  fi
fi

# Helper functions for demo
run-processor() {
  echo "üöÄ Starting ML ticket processor..."
  python -m src.processor.worker
}

show-results() {
  echo "üìä Enriched Tickets in S3:"
  awslocal s3 ls s3://tickets-enriched/ | head -10
  echo ""
  echo "üìù Sample enriched ticket:"
  local ticket=$(awslocal s3 ls s3://tickets-enriched/ | head -1 | awk '{print $4}')
  if [ -n "$ticket" ]; then
    awslocal s3 cp s3://tickets-enriched/$ticket - | python -m json.tool | head -40
  fi
}

show-sentiment() {
  local sentiment=${1:-NEGATIVE}
  echo "üòä Tickets with sentiment: $sentiment"
  awslocal dynamodb scan \
    --table-name tickets-metadata \
    --filter-expression "sentiment = :s" \
    --expression-attribute-values "{\":s\":{\"S\":\"$sentiment\"}}" \
    --output json | python -c "
import sys, json
data = json.load(sys.stdin)
for item in data.get('Items', []):
    ticket_id = item['ticket_id']['S']
    intent = item['intent']['S']
    urgency = item['urgency']['S']
    summary = item['summary']['S']
    print(f'{ticket_id}: {intent} ({urgency}) - {summary[:60]}...')
" 2>/dev/null || echo "No tickets found with sentiment: $sentiment"
}

show-urgent() {
  echo "üö® Critical/High Urgency Tickets:"
  awslocal dynamodb scan \
    --table-name tickets-metadata \
    --filter-expression "urgency IN (:c, :h)" \
    --expression-attribute-values '{":c":{"S":"critical"},":h":{"S":"high"}}' \
    --output json | python -c "
import sys, json
data = json.load(sys.stdin)
for item in data.get('Items', []):
    ticket_id = item['ticket_id']['S']
    urgency = item['urgency']['S']
    intent = item['intent']['S']
    sentiment = item['sentiment']['S']
    print(f'{ticket_id}: [{urgency.upper()}] {intent} (sentiment: {sentiment})')
" 2>/dev/null || echo "No urgent tickets found"
}

demo() {
  echo "üé¨ Running ML Ticket Processing Demo"
  echo "===================================="
  echo ""
  echo "1Ô∏è‚É£  Checking LocalStack status..."
  make status 2>/dev/null || echo "LocalStack running"
  echo ""
  echo "2Ô∏è‚É£  Running processor on sample tickets..."
  timeout 30 python -m src.processor.worker 2>/dev/null || echo "Processed tickets (or already done)"
  echo ""
  echo "3Ô∏è‚É£  Showing results..."
  show-results
  echo ""
  echo "4Ô∏è‚É£  Negative sentiment tickets:"
  show-sentiment NEGATIVE
  echo ""
  echo "5Ô∏è‚É£  Urgent tickets:"
  show-urgent
  echo ""
  echo "‚úÖ Demo complete!"
  echo ""
  echo "Available commands:"
  echo "  run-processor    - Run the ML processor"
  echo "  show-results     - View enriched tickets"
  echo "  show-sentiment   - Query by sentiment (POSITIVE/NEGATIVE/NEUTRAL)"
  echo "  show-urgent      - Show critical/high urgency tickets"
  echo "  demo             - Run this demo again"
}
'''
fish = '''
source "$PYTHON_DIR/bin/activate.fish"

# Wait for LocalStack (fish syntax - idempotent version)
if test "$FLOX_ACTIVATE_START_SERVICES" = "true"
  # Quick check: do resources already exist?
  if awslocal sqs get-queue-url --queue-name ticket-processing-queue >/dev/null 2>&1
    echo "‚úÖ LocalStack resources already configured"
  else
    echo "‚è≥ Waiting for LocalStack to be ready..."
    for i in (seq 1 60)
      if curl -sf http://localhost:4566/_localstack/health >/dev/null 2>&1
        echo "‚úÖ LocalStack is responding"
        sleep 2
        echo "üîß Setting up LocalStack resources..."
        test -f "Makefile"; and make setup >/dev/null 2>&1; and make seed >/dev/null 2>&1
        echo "‚úÖ Resources configured"
        break
      end
      sleep 1
    end
  end
end
'''
tcsh = '''
source "$PYTHON_DIR/bin/activate.csh"
'''
zsh = '''
source "$PYTHON_DIR/bin/activate"

# Wait for LocalStack (same as bash - idempotent version)
if [[ "$FLOX_ACTIVATE_START_SERVICES" == "true" ]]; then
  # Quick check: do resources already exist?
  if awslocal sqs get-queue-url --queue-name ticket-processing-queue >/dev/null 2>&1; then
    echo "‚úÖ LocalStack resources already configured"
  else
    echo "‚è≥ Waiting for LocalStack to be ready..."

    for i in {1..60}; do
      if curl -sf http://localhost:4566/_localstack/health >/dev/null 2>&1; then
        echo "‚úÖ LocalStack is responding"
        sleep 2

        echo "üîß Setting up LocalStack resources..."
        if [ -f "Makefile" ]; then
          make setup 2>&1 | grep -E "(‚úì|‚úó|Error)" || true
          make seed 2>&1 | grep -E "(‚úì|‚úó|Uploaded)" || true
          echo "‚úÖ Resources configured"
        elif [ -f "$FLOX_ENV/share/setup/Makefile" ]; then
          cd "$FLOX_ENV/share/setup"
          make setup 2>&1 | grep -E "(‚úì|‚úó|Error)" || true
          make seed 2>&1 | grep -E "(‚úì|‚úó|Uploaded)" || true
          cd "$FLOX_ENV_PROJECT"
          echo "‚úÖ Resources configured"
        else
          echo "‚ö†Ô∏è  No Makefile found - skipping setup"
        fi
        break
      fi
      sleep 1
    done
  fi
fi

# Helper functions for demo (same as bash)
run-processor() {
  echo "üöÄ Starting ML ticket processor..."
  python -m src.processor.worker
}

show-results() {
  echo "üìä Enriched Tickets in S3:"
  awslocal s3 ls s3://tickets-enriched/ | head -10
  echo ""
  echo "üìù Sample enriched ticket:"
  local ticket=$(awslocal s3 ls s3://tickets-enriched/ | head -1 | awk '{print $4}')
  if [ -n "$ticket" ]; then
    awslocal s3 cp s3://tickets-enriched/$ticket - | python -m json.tool | head -40
  fi
}

show-sentiment() {
  local sentiment=${1:-NEGATIVE}
  echo "üòä Tickets with sentiment: $sentiment"
  awslocal dynamodb scan \
    --table-name tickets-metadata \
    --filter-expression "sentiment = :s" \
    --expression-attribute-values "{\":s\":{\"S\":\"$sentiment\"}}" \
    --output json | python -c "
import sys, json
data = json.load(sys.stdin)
for item in data.get('Items', []):
    ticket_id = item['ticket_id']['S']
    intent = item['intent']['S']
    urgency = item['urgency']['S']
    summary = item['summary']['S']
    print(f'{ticket_id}: {intent} ({urgency}) - {summary[:60]}...')
" 2>/dev/null || echo "No tickets found with sentiment: $sentiment"
}

show-urgent() {
  echo "üö® Critical/High Urgency Tickets:"
  awslocal dynamodb scan \
    --table-name tickets-metadata \
    --filter-expression "urgency IN (:c, :h)" \
    --expression-attribute-values '{":c":{"S":"critical"},":h":{"S":"high"}}' \
    --output json | python -c "
import sys, json
data = json.load(sys.stdin)
for item in data.get('Items', []):
    ticket_id = item['ticket_id']['S']
    urgency = item['urgency']['S']
    intent = item['intent']['S']
    sentiment = item['sentiment']['S']
    print(f'{ticket_id}: [{urgency.upper()}] {intent} (sentiment: {sentiment})')
" 2>/dev/null || echo "No urgent tickets found"
}

demo() {
  echo "üé¨ Running ML Ticket Processing Demo"
  echo "===================================="
  echo ""
  echo "1Ô∏è‚É£  Checking LocalStack status..."
  make status 2>/dev/null || echo "LocalStack running"
  echo ""
  echo "2Ô∏è‚É£  Running processor on sample tickets..."
  timeout 30 python -m src.processor.worker 2>/dev/null || echo "Processed tickets (or already done)"
  echo ""
  echo "3Ô∏è‚É£  Showing results..."
  show-results
  echo ""
  echo "4Ô∏è‚É£  Negative sentiment tickets:"
  show-sentiment NEGATIVE
  echo ""
  echo "5Ô∏è‚É£  Urgent tickets:"
  show-urgent
  echo ""
  echo "‚úÖ Demo complete!"
  echo ""
  echo "Available commands:"
  echo "  run-processor    - Run the ML processor"
  echo "  show-results     - View enriched tickets"
  echo "  show-sentiment   - Query by sentiment (POSITIVE/NEGATIVE/NEUTRAL)"
  echo "  show-urgent      - Show critical/high urgency tickets"
  echo "  demo             - Run this demo again"
}
'''

[options]
systems = ["aarch64-darwin", "aarch64-linux", "x86_64-darwin", "x86_64-linux"]

